# 2020-Django 3 by Example - Chapter 4-6

### Starting the Social Website Project

### Setting up the virtual environment
mkdir env
python3 -m venv env/bookmarks 
source env/bookmarks/bin/activate

### Installing the modules
pip3 install Django;
pip3 install Pillow==7.0.0;
pip3 install social-auth-app-django==3.1.0;
pip3 install django-extensions==2.2.5; 
pip3 install werkzeug==0.16.0; 
pip3 install pyOpenSSL==19.0.0;
pip3 install easy-thumbnails==2.7;
pip3 install --upgrade certifi;

### Sync Database with the models 
python3 manage.py migrate

### Setting up an Admin-account
python3 manage.py createsuperuser

### Start the server:
python3 manage.py runserver_plus --cert-file cert.crt

### Server blocked? - just type: 
thisisunsafe

### test the image saving: 
https://127.0.0.1:8000/images/create/?title=test&url=https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Georgios_Jakobides_Girl_reading_c1882.jpg/800px-Georgios_Jakobides_Girl_reading_c1882.jpg


### Chapter 4: Building a Social Website

- Django AUth framework is included in default settings of the project (used it for admin in earlier chapters).
- Consists of django.contrib.auth application and two middleware classes: AuthentificationMiddleware (associates users with requests using sessions), and SessionMiddleware (handles the current session across requests).
- Auth framework includes three models:
    - User: User model with basic fields (username, password, mail, first_name, ...)
    - Group: group model to categorize users
    - Permission: Flags for users or groups to perform certain actions

#### Create a login view

- Create a new forms.py in account application
- Edit the views.py file to add the user_login method
- The difference between auth and login:
    - Authenticate: checks user credentials and returns a User object.
    - Login: sets the user in the current session.
- Create the URL pattern of this view by craeting a new urls.py file. Edit the urls.py file in the django base project.
- Create a template for the view (login page). Starting with the base.html template which will be extended by the login.html file (add the .css from the books source code).
- Create a superuser in order to create users because there is no registration yet.
-> This was a manual process for understanding. Usually, you take the default Django authentification views.

Views:
- Class-based views: Login and Logout views
- Views for password change: passwordchangeview and passwordchangedoneview
- Password reset views: PasswordResetView, pwresetdoneview, passwordresetconfirmview, passwordresetcompleteview

Login and logout views: 
- You have added the built-in Django authentication log in and log out views to your project
- You have created custom templates for both views and defined a simple dashboard view to redirect users after they log in
- Finally, you have configured your settings for Django to use these URLs by default
- Now log-in/log-out links need to be added to the base template, therefore it must be determined if user is logged in or not. 
- Next the change password views are integrated: add new dedicated htmls in the templates/registration directory; 
Resetting password views: 
- extend the urls.py with the respective views
- add a dedicated html-form named password_reset_form.html and a password_reset_email.html (this will include a reset token generated by the view).
- also create 'password_reset_done.html' and 'password_reset_confirm.html', and 'password_reset_complete.html' files
- adapt the link in registration/login.html href to '{% url "password_reset %}'
- next a SMTP configuration is needed in the settings.py to send mails via Django. Here this is done via the EMAIL_BACKEND 

#### User Registration
- Create a simple view to allow users to register (with realname, mail, username, and password)
- edit the forms.py in the account directory; in the form two passwords (1 and 2) are given for checking them
- Django also has a UserRegistrationForm
- extend views.py by 'def register():' function; instead of saving the raw password the 'set_password()' function is used.
- adapt the urls.py file and add the register path
- create a new template named register.html in account/ directory
- add template register_done.html 

#### Extending the User Model
- e.g. images and date_of_birth are added
- make sure you run the makemigrations functions to update the database

#### Using the Messages Framework
- django.contrib.messages allows you to show one-time messages to users.
- messages are stored in a cookie by default; therefore import the messages module
- u can display the messages in the base template 

#### Building a custom authentification backend
- this way you can authenticate against LDAP for instance

#### Adding social authentication to your site
- use social-auth-app-django==3.1.0 to connect via Twitter, Facebook or Google
- register the installed_app 'social_django'
- next add the social login URL pattern to urs.py as a path 'social-auth/'

#### Running the development server through HTTPS
- only do this on development server; never on deployed web server!
- use external third party django app RunServerPlus for the HTTPS support; Django can't do it but the social media services demand it
- install django extensions: pip install django-extensions==2.2.5
- debugger layer for RunServerPlus extension: pip install werkzeug==0.16.0
- install pyOpenSSL which is requ for RSP: pip install pyOpenSSL==19.0.0
- register the app in settings.py as 'django_extensions'
- now you need to run the server with a certificate file: python manage.py runserver_plus --cert-file cert.crt

#### Authentification using Facebook
- add the facebook auth to the settings.py: 'social_core.backends.facebook.FacebookOAuth2',
- u need a [facebook developer account]( https://developers.facebook.com/apps/) and a new facebook application in the django project.
- do some fiddling on the facebook web page. Use it once, you try this out.
- After setting everything on the facebook page, you can add the facebook login button to your login.html template.

#### Twitter, and Google are presented too.

#### Summary
- build auth into the site
- implemented views like register, log-in, log-out, edit password, reset password
- buiolt a model for custom user profiles
- created a custom auth backend
- added social auth via Facebook

### Chapter 5: Creating an Image Bookmarking Website

#### Creating an Image Bookmarking Website

##### Build the Image Model
- Create new application within bookmarks called images via django-admin startapp images & register it in the settings.py file of bookmarks
- Edit the models.py file of images application and add the class Image: which will be used to store images retrieved from different sites.
- override the save() method of the Image model to automatically generate the slug field based on the value of the title field. Import the slugify() function and add a save() methode to the Image model 

##### Creating many-2-many relationships

- integrate n2n relationship as multiple users may like an image, and an image can be liked by multiple users 
- a join table is created, field provdes a manager that allows to retrieve related objects, such as image.users_like.all() or get them from a user object such as user.images_liked.all()
- migrate the images database to sync the model with the database
 
##### Registering the Image Model in the Administration Site

- Edit the admin.py file of the images application and register the Image model, then start the development server.
- type 'thisisunsafe' to get access.

#### Posting Content from other Websites

- uers can bookmark images from external sites. User will provide the URL of the image, a title, and a description. The application willl then download the image. 
- therefore create a new forms.py in images application directory.

##### Cleaning form fields
- Check if filename is a JPEG file by including a validation technique. 
- You also need to download the image file and save it. 

##### Overriding the save() method of a ModelForm

- override the standard save() method in order to retrieve the given image and save it.
- procedure: (1) create a new image insatance by calling save() method with commit = false; (2) get the URL from cleaned_data dict; (3) generate the image name by combining the image title slug; (4) urllib to download the image and call save() passing a ContentFile object through which file is saved to the media directory of the project; (5) only save file when the commit parameter is True.
- for urllib through HTTPS you need Certifi Python pacakge. 
- build a view for handling the form
- register the url in urls.py of images and in the main application
- create a template to render the form create.html and add the following code to it. 

Note: Got an error.

##### Building a bookmarklet with JQuery

- bookmarklet is a bookmark stored in a web browser that contains JavaScript code to extend the browser's functionality.
- when you click the bookmark, the JS code is executed on the website being displayed in the browser. 
- Pinterst implements their own bookmarklets to let users share content from other sites onto their platform. We do this with JQuery.
- JQuery is a popular JavaScript library that allows to develop client-side functionality faster. 
- Logic:
    - user drags link from site to their browsers bookmarks. We will implement a launcher script that allows to update the code of the bookmarklet at any time. 
    
- Create a template in images/templates named bookmarklet_launcher.js : it will discover wheter the bookmarklet has already been loaded; if not: you load another JS file bookmarklet.js that allows to update the bookmarklet.
- add the bookmarklet launcher to the dashboard to copy it to the bookmarks of the user 
- django does not support mutliple line tags; see the dashboard in browser
- create static/js/bookmarklet.js and copy the code from the book: jquery script loads from Google content delivery network (CDN) 
- also copy the css file
- with the code you can bookmark any image, by attaching a click() event to each image's link element.
- when a user clicks on an image, you set a new variable called selected_image that contains the URL of the selected image.
- You hide the boomarklet and open a new browser window with the URL for bookmarking a new image on your site. Pass the content of the <title> element of the website and the selected image URL as 'GET' parameters.

#### Creating a Detail View for Images

- open views.py of the images application and add a simple view to display the image. 
- edit urls.py file of the images application and add a url parameter
- edit models.py of images application and at the get_absolute_url() method to the Image model (rmb that the common pattern for providing canonical URLs for objects is to define a get_absolute_url() method in th model)
- create a template inside /images/image template directory of the images app and name it detail.html 
 
##### Creating Image Thumbnails using easy-thumbnails

- display orig image on the detail page may have to big dimensions. Therefore use easy-thumbnail to fit them. 
- Register it in settings.py under INSTALLED_APPS
- run python3 manage.py migrate to sync it with the database
- edit the detail.html template by including the thumnail image.image 300x0 tag. The width now is fixed with 300px and the height is flexible indicated by 0. 
- an thumbnail will now be automatically generated and displayed on the site. the 85 indicates 85% quality in storage.

#### Adding AJAX actions with JQuery

- AJAX comes from Asynchronous JavaScript and XML and encompasses techniques to make asnyc HTTP requests. It consists of sending and retrieving data from the server asyncly, w/o reloading the whole page. Despite the name XML is not required. It also works with formats like JSON, HTML or plain text.
- Here we add a link to the image detail page to let users click on it in order to like an image. This will be done with an AJAX call to avsoid reloading the whole page.
- First, create a view for users to like/unlike images. Edit the views.py file of the images application. There are two decorators: login_required (only for logged in users), and the require_POST that returns a HttpResponseNotAllowed object (405) if the HTTP request is not done via POST. This way, only POST requests will be allowed for this view.
- two POST parameters are defined:
    - image_id: The ID of the image object on which the user is performing the action. 
    - action: The action that the user wants to perform, which you assume to be a string with the value 'like' or 'unlike'.

##### Loading JQuery

- for adding AJAX functionality include it within the </body> html tag of the base.html.
- you load the jQuery framework from Google's CDN
- $(document).ready() is a jQuery function that takes a handler that is executed when the Document Object Model (DOM) hierarchy has been fully constructed. The DOM is created by the browser when a web page is loaded, and it is constructed as a tree of objects. By including your code inside this function, you will make sure that all HTML elements that are going to interact with are loaded in the DOM. Code is only executed if the DOM is ready.

##### Cross-site requests forgery in AJAX requests

- with CSRF protection active, Django checks for a CSRF token in all POST requests. This is inconvenient for AJAX requests. 
- Therefore, Django allows to set a custom X-CSRFToken header in the AJAX requests with the value of the CSRF token. To include the token in all requests, you need to:
    - retrieve the csrf token from the csrftoken cookie, which is set if SCRF protection is active
    - send the token in the AJAX request using the X-CSRFToken heder

##### Performing AJAX requests with JQuery

- Edit the images/image/detail.html template of the images application
- You will send the value of both attributes in the AJAX request to the image_like view. When a user clicks on the like/unlike link, you will perform the following action on the client side.
- Also add the domready block at the bottom of the images/image/detail.html template it allows to open the image detail page and to see initial likes count and the like button.

#### Creating Custom Decorators for your Views

- Django request object provides an is_ajax() method that checks whether the request is being made with XMLHttpRequest, this value is set in the HTTP_X_REQUESRTED_WITH HTTP header, which is included in AJAX requests by most JavaScript libraries
- we create a decorator for checking the HTTP_X_REQUESRTED_WITH HTTP in the views. 
- Decorator is a function that takes another function and extends the behavior of the latter without explicitly modifying it. 
- since the decorator will be generic, a common Python Package will be created. 
- In the bookmarks project directory a folder 'common' and an __init__.py and a decorators.py are needed
- preceding code is the custom ajax_required decorator (defines a wrap function that returns an HTTP_X_REQUESRTED_WITH HTTP object).
- edit the views.py file of the images application and add the decorator with '@ajax_required' after from common.decorators import ajax_required
#### Adding AJAX pagination to your list views

- use AJAX to built an infinite scroll functionality which is achieved by loading the next results automatically when the user scrolls to the bottom of the page 
- therefore, implement an image list view that will handle both standard browser requests and AJAX requests, including pagination: when the user initially loads the image list page, you will display the first page of images, when they scroll to the bottom of the page, you will load the following page of items via AJAX and append it to the bottom of the main page. 
- Edit the views.py and the urls.py of the images application
- Mentioned templates need to be created inside the images/image/ template directory which is named list_ajax.html. This will display the list of images
- it is used to return results for AJAX requests by iterating over oimages and generate a square 300px thumbnail for each image (by using smart cropping)
- craete a temlate in the same directory named list.html (extends base.html and includes the ajax_list.html) it will hold the JS code for loading additional pages when scrolling to the bottom of the page
- finally edit the base.html template and add the URL for the images item of the main menu 
#### Summary

- Models were created with many-to-many relationships
- How behavior of forms can be modified
- with jQuery a JavaScript bookmarklet was build
- easy-thumbnails were created
- AJAX views with jQuery and AJAX pagination were added



### Chapter 6: Tracking User Action

Learnings: build a follow system and an activity stream. Work with generic relations, signals, and denormalization,. Learn how to use Redis with Django.

#### Building a Follow System

##### Creating many-to-many relationships with an intermediary ...
##### Creating list and detail views for user profiles
##### Building an AJAX view to follow users

#### Building a Generic Activity Stream Application

##### Using the contenttypes framework
##### Adding generic relations to your models
##### Avoiding duplicate actions in the activity stream
##### Adding user actions to the activity stream
##### Displaying the activity stream
##### Optimizing QuerySets that involve related objects
###### Using select_related()
###### Using prefetch_related()
##### Creating templates for actions

#### Using Signals for Denormalizing Counts

##### Working with signals
##### Application configuration classes

#### Using Redis for Storing Item Views

##### Installing Redis
##### Using Redis with Python
##### Storing item views in Redis
##### Storing a ranking in Redis
##### Next steps with Redis

#### Summary
#### Summary